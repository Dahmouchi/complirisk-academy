// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LiveType {
  YOUTUBE
  LIVEKIT
  JITSI
}

enum LiveStatus {
  DRAFT
  SCHEDULED
  LIVE
  ENDED
  CANCELLED
}

model NotesGlobal {
  id        String   @id @default(uuid())
  content   String
  color     String
  emoji     String? // optional
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
}

model Badge {
  id          String   @id @default(cuid())
  name        String   @unique // Add this
  description String
  icon        String
  condition   Json
  createdAt   DateTime @default(now())

  earnedBy EarnedBadge[]
}

model EarnedBadge {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId]) // user can earn it only once
}

model News {
  id       String  @id @default(uuid())
  title    String
  content  String  @db.Text
  excerpt  String? // Short summary for preview
  imageUrl String?

  // Priority: HIGH, MEDIUM, LOW
  priority NewsPriority @default(MEDIUM)

  // Published status
  published   Boolean   @default(false)
  publishedAt DateTime?

  // Link to grades (students of these grades can see it)
  grades NewsGrade[]

  // Author (admin or teacher)
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId])
  @@index([published])
  @@index([publishedAt])
}

// Junction table for News-Grade many-to-many relationship
model NewsGrade {
  id      String @id @default(uuid())
  newsId  String
  gradeId String

  news  News  @relation(fields: [newsId], references: [id], onDelete: Cascade)
  grade Grade @relation(fields: [gradeId], references: [id], onDelete: Cascade)

  @@unique([newsId, gradeId])
  @@index([newsId])
  @@index([gradeId])
}

enum NewsPriority {
  HIGH
  MEDIUM
  LOW
}

model UserActivity {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        ActivityType // ðŸ‘ˆ "login", "course_completed", etc.
  description String? // Optional text to add details

  courseId String? // Optional: when activity relates to a course
  quizId   String? // Optional: when activity relates to a quiz
  meta     Json? // ðŸ‘ˆ Save extra dynamic data (duration, score, device...)

  createdAt DateTime @default(now())
}

enum ActivityType {
  LOGIN
  LOGOUT
  VIEW_PAGE
  START_COURSE
  COMPLETE_COURSE
  START_LESSON
  COMPLETE_LESSON
  START_QUIZ
  COMPLETE_QUIZ
  PASS_QUIZ
  FAIL_QUIZ
  UPDATE_PROFILE
  OTHER
}

// file: prisma/schema.prisma

// 1. Landing Page Section Model
// Represents a major content block on the landing page (like 'ExampleSection2')
model Section {
  id                 String         @id @default(uuid())
  // A unique identifier for the section (e.g., 'why_choose_enita', 'hero_banner', 'testimonials')
  key                String         @unique
  // The main title for the section (e.g., "Pourquoi choisir ENITA ?")
  title              String
  // The main subtitle/description for the section
  subtitle           String?
  description        String?
  levels             LevelLanding[]
  // Optional: The background image URL or asset path (e.g., '/Board.png')
  backgroundImageUrl String?
  heroImageUrl       String?
  layoutType         String?
  checklistItems     String?
  // Optional: A class name or style key to define the overall look of the section
  designStyleKey     String?

  // Optional: An array of feature items associated with this section
  featureItems FeatureItem[]
  // Optional: A number to control the display order on the page
  order        Int           @default(0)
  visible      Boolean       @default(true)
  // Timestamps
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model LevelLanding {
  id        String         @id @default(uuid())
  name      String
  grades    GradeLanding[]
  order     Int            @default(0)
  sectionId String
  section   Section        @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sectionId, order])
}

model GradeLanding {
  id       String           @id @default(uuid())
  name     String
  order    Int              @default(0)
  subjects SubjectLanding[]
  levelId  String
  level    LevelLanding     @relation(fields: [levelId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([levelId, order])
}

model SubjectLanding {
  id        String       @id @default(uuid())
  name      String
  color     String // Tailwind color
  gradeId   String
  grade     GradeLanding @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

// 2. Individual Feature Item Model
// Represents one bullet point or card within a Section
model FeatureItem {
  id          String @id @default(uuid())
  // The text content of the feature (e.g., "DiplÃ´mes FranÃ§ais Reconnus")
  title       String
  // The detailed description (e.g., "Formations diplÃ´mantes de Bac+2 Ã  Bac+5...")
  description String
  // The class name or identifier for the icon (e.g., 'Award', 'Briefcase')
  // This helps the frontend render the correct icon component.
  iconName    String
  // A number to control the display order within the section
  order       Int    @default(0)

  // Relationship to the parent Section
  sectionId String
  section   Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Ensures the combination of sectionId and order is unique
  @@unique([sectionId, order])
}

model Note {
  id        String   @id @default(cuid())
  content   String // Raw text from student
  userId    String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  magicNote MagicNote? // relation to AI-processed note
}

model MagicNote {
  id         String @id @default(cuid())
  noteId     String @unique // one magic note per raw note
  summary    String // AI-generated summary
  schema     Json // hierarchical schema (mindmap JSON)
  flashcards Json // flashcards [{q, a}, ...]

  createdAt DateTime @default(now())

  note      Note        @relation(fields: [noteId], references: [id], onDelete: Cascade)
  flashCard Flashcard[]
}

model Flashcard {
  id          String @id @default(cuid())
  question    String
  answer      String
  magicNoteId String

  magicNote MagicNote @relation(fields: [magicNoteId], references: [id], onDelete: Cascade)
}

model LiveRoom {
  id              String     @id @default(cuid())
  name            String
  description     String?
  image           String?
  type            LiveType   @default(LIVEKIT)
  status          LiveStatus @default(DRAFT)
  teacherId       String
  teacher         User       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  isQuizPublished Boolean    @default(false)
  subjectId       String?
  subject         Subject?   @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  gradeId String?
  grade   Grade?  @relation(fields: [gradeId], references: [id])
  quizzes Quiz[]

  // Platform-specific fields
  youtubeVideoId String?
  livekitRoom    String? @unique
  jitsiRoom      String?

  egressId        String?
  recordingStatus String?
  recordingUrl    String?

  // Metadata
  maxParticipants  Int?    @default(100)
  recordingEnabled Boolean @default(true)
  chatEnabled      Boolean @default(true)

  startsAt DateTime?
  endedAt  DateTime?
  duration Int? // Duration in minutes

  participants LiveRoomParticipant[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  liveCredentials LiveCredentials[]

  @@index([teacherId])
  @@index([subjectId])
  @@index([status])
}

model LiveCredentials {
  id         String   @id @default(cuid())
  liveRoomId String
  liveRoom   LiveRoom @relation(fields: [liveRoomId], references: [id], onDelete: Cascade)

  token    String
  url      String
  roomName String
}

model LiveRoomParticipant {
  id         String   @id @default(cuid())
  liveRoomId String
  liveRoom   LiveRoom @relation(fields: [liveRoomId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  @@unique([liveRoomId, userId])
  @@index([liveRoomId])
  @@index([userId])
}

model Niveau {
  id      String  @id @default(cuid())
  handler String  @unique // short readable identifier (e.g. "fractions-course")
  name    String // "Primaire", "CollÃ¨ge", "LycÃ©e"
  grades  Grade[]
}

model CourseProgress {
  id          String    @id @default(cuid())
  userId      String
  courseId    String
  completed   Boolean   @default(false)
  completedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId]) // One record per user/course
}

model Grade {
  id                       String                    @id @default(cuid())
  handler                  String                    @unique // short readable identifier (e.g. "fractions-course")
  name                     String // "CE1", "2AC", "1Bac"...
  niveauId                 String
  price                    Int                       @default(0)
  niveau                   Niveau                    @relation(fields: [niveauId], references: [id], onDelete: Cascade)
  users                    User[]
  subjects                 Subject[]
  liveRooms                LiveRoom[]
  teacherSubjects          TeacherSubject[]
  newsGrades               NewsGrade[]
  demandeInscriptionGrades DemandeInscriptionGrade[]
  demandeInscriptions      DemandeInscription[]
}

model Subject {
  id          String           @id @default(cuid())
  handler     String           @unique // short readable identifier (e.g. "fractions-course")
  name        String
  description String?
  color       String
  gradeId     String
  grade       Grade            @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  courses     Course[]
  teachers    TeacherSubject[]
  liveRooms   LiveRoom[]
}

model CourseChatNotification {
  id String @id @default(cuid())

  messageId String
  message   CourseChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@unique([messageId, userId])
  @@index([userId, isRead])
}

model CourseChatMessageRead {
  id String @id @default(cuid())

  messageId String
  message   CourseChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  readAt DateTime @default(now())

  @@unique([messageId, userId])
  @@index([userId])
  @@index([messageId, readAt])
}

model CourseChatMessage {
  id      String @id @default(cuid())
  content String

  parentId String?
  parent   CourseChatMessage?  @relation("MessageReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  CourseChatMessage[] @relation("MessageReplies")

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)

  reads         CourseChatMessageRead[]
  notifications CourseChatNotification[] // âœ… ADDED THIS!

  createdAt DateTime @default(now())

  @@index([parentId])
  @@index([courseId])
  @@index([courseId, createdAt])
  @@index([senderId, courseId])
}

model Course {
  id         String              @id @default(cuid())
  title      String
  content    String?
  videoUrl   String?
  coverImage String?
  handler    String              @unique
  index      Int
  subjectId  String
  isFree     Boolean             @default(false)
  subject    Subject             @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  documents  Document[]
  quizzes    Quiz[]
  progress   CourseProgress[]
  notes      Note[]
  chat       CourseChatMessage[]

  createdAt DateTime @default(now())

  @@index([index])
}

model Document {
  id       String @id @default(cuid())
  name     String
  url      String
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Quiz {
  id         String       @id @default(cuid())
  title      String
  courseId   String?
  course     Course?      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions  Question[]
  quizResult QuizResult[]

  liveRoomId String?
  liveRoom   LiveRoom? @relation(fields: [liveRoomId], references: [id], onDelete: Cascade)
}

model Question {
  id      String   @id @default(cuid())
  content String
  answer  String
  quizId  String
  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options Option[] // New relation
}

model Option {
  id         String   @id @default(cuid())
  text       String
  isCorrect  Boolean
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model QuizResult {
  id             String   @id @default(cuid())
  quizId         String
  userId         String
  score          Int
  totalQuestions Int
  percentage     Int
  completedAt    DateTime @default(now())
  attempts       Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

model RegisterCode {
  id        String    @id @default(cuid())
  code      String    @unique
  isUsed    Boolean   @default(false) // statut: consommÃ© or not
  createdAt DateTime  @default(now())
  usedAt    DateTime? // when the code was consumed
  user      User?     @relation(fields: [userId], references: [id])
  userId    String?   @unique // One user can be linked to one code
}

model User {
  id               String     @id @default(cuid())
  name             String?
  email            String     @unique
  archive          Boolean    @default(false)
  createdAt        DateTime   @default(now())
  emailVerified    DateTime?
  image            String?
  step             Int        @default(0)
  phone            String?
  age              Int?
  totalTimeSpent   Int?       @default(0) // Total time spent on the platform in seconds
  password         String?
  universite       String?
  universiteCity   String?
  fonction         String?
  lieuEtudeTravail String?
  prenom           String?
  qrSecret         String?
  role             Role       @default(USER)
  statut           Boolean    @default(true)
  StatutUser       StatutUser @default(awaiting)
  twoFactorEnabled Boolean    @default(true)
  twoFactorSecret  String?
  updatedAt        DateTime   @updatedAt
  username         String     @unique
  verified_email   String?
  streak           Int        @default(0)
  lastLoginDate    DateTime?

  // Relations
  grades               Grade[] // Changed from single grade to many-to-many
  registerCode         RegisterCode?
  courseProgress       CourseProgress[] // ðŸ‘ˆ Progress relation
  accounts             Account[]
  quizResult           QuizResult[]
  Authenticator        Authenticator[]
  sessions             Session[]
  notes                Note[]
  activities           UserActivity[]
  badges               EarnedBadge[]
  notesGlobal          NotesGlobal[]
  liveRooms            LiveRoom[]
  liveRoomParticipants LiveRoomParticipant[]

  messages           CourseChatMessage[] // existing
  chatReads          CourseChatMessageRead[] // âœ… ADD THIS
  chatNotifications  CourseChatNotification[] // âœ… ADD THIS
  teacherSubjects    TeacherSubject[]
  news               News[]
  demandeInscription DemandeInscription[] // Registration requests
}

model TeacherSubject {
  id        String   @id @default(cuid())
  teacherId String
  subjectId String
  gradeId   String
  createdAt DateTime @default(now())

  teacher User    @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  grade   Grade   @relation(fields: [gradeId], references: [id], onDelete: Cascade)

  @@unique([teacherId, subjectId, gradeId])
  @@index([teacherId])
  @@index([subjectId])
  @@index([gradeId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?
  user                 User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}

enum Role {
  USER
  ADMIN
  TEACHER
}

enum StatutUser {
  subscribed
  awaiting
  verified
}

enum DemandeInscriptionStatus {
  PENDING // En attente
  APPROVED // ApprouvÃ©e
  REJECTED // RejetÃ©e
  CANCELLED // AnnulÃ©e
}

model DemandeInscription {
  id String @id @default(cuid())

  // User who created the inscription request
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Selected grades for inscription (many-to-many)
  grades DemandeInscriptionGrade[]

  // Price information
  totalPrice Int @default(0)

  // Status of the request
  status DemandeInscriptionStatus @default(PENDING)

  // Additional information
  notes           String? @db.Text // Optional notes from the user
  rejectionReason String? @db.Text // Reason for rejection if status is REJECTED

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  treatedAt DateTime? // When the request was approved/rejected
  treatedBy String? // Admin/User ID who treated the request
  grade     Grade?    @relation(fields: [gradeId], references: [id])
  gradeId   String?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// Junction table for DemandeInscription-Grade many-to-many relationship
model DemandeInscriptionGrade {
  id                   String @id @default(cuid())
  demandeInscriptionId String
  gradeId              String
  gradePrice           Int    @default(0) // Price for this specific grade

  demandeInscription DemandeInscription @relation(fields: [demandeInscriptionId], references: [id], onDelete: Cascade)
  grade              Grade              @relation(fields: [gradeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([demandeInscriptionId, gradeId])
  @@index([demandeInscriptionId])
  @@index([gradeId])
}
